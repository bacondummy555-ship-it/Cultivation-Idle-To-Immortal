<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Path to Immortality | Absolute Apex</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --realm-color: #4c1d95; --glow: rgba(139, 92, 246, 0.5); }
        body { background-color: #050507; color: #e2e8f0; font-family: 'Georgia', serif; overflow-x: hidden; }
        .qi-gradient { background: linear-gradient(90deg, var(--realm-color), #fff); box-shadow: 0 0 20px var(--realm-color); }
        .mystic-border { border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 0 20px rgba(0,0,0,0.5); background: rgba(15, 15, 20, 0.8); backdrop-filter: blur(10px); }
        
        @keyframes shake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(-5px,5px); } 50% { transform: translate(5px,-5px); } }
        .strike { animation: shake 0.2s ease-in-out 3; background: white !important; }
        .float { animation: float 4s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--realm-color); border-radius: 10px; }
    </style>
</head>
<body class="p-4 transition-colors duration-1000">

    <div id="reincarnation-screen" class="fixed inset-0 bg-black z-50 hidden flex-col items-center justify-center p-6 text-center">
        <h2 class="text-6xl font-bold text-yellow-500 mb-4">Life Exhausted</h2>
        <p class="text-xl text-gray-400 mb-8 italic" id="death-msg"></p>
        <div class="text-2xl mb-8">Karma Earned: <span id="karma-gain" class="text-green-400 font-bold">0</span></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl">
            <button onclick="game.reincarnate(1, 0)" class="p-4 border border-gray-700 hover:border-purple-500 rounded-xl">Mortal Root (1x Speed) - 0 Karma</button>
            <button onclick="game.reincarnate(3, 200)" class="p-4 border border-gray-700 hover:border-purple-500 rounded-xl">Earth Root (3x Speed) - 200 Karma</button>
            <button onclick="game.reincarnate(10, 1000)" class="p-4 border border-gray-700 hover:border-purple-500 rounded-xl">Heavenly Root (10x Speed) - 1000 Karma</button>
            <button onclick="game.reincarnate(50, 5000)" class="p-4 border border-gray-700 hover:border-purple-500 rounded-xl">Divine Root (50x Speed) - 5000 Karma</button>
        </div>
    </div>

    <div id="event-modal" class="fixed inset-0 bg-black/80 z-40 hidden items-center justify-center p-4">
        <div class="mystic-border p-8 rounded-3xl max-w-md text-center border-t-4 border-yellow-500">
            <h3 id="event-title" class="text-2xl font-bold mb-4 text-yellow-500"></h3>
            <p id="event-desc" class="text-gray-300 mb-6"></p>
            <div class="flex flex-col gap-3">
                <button id="event-opt1" class="bg-purple-900/50 p-3 rounded-lg hover:bg-purple-800 transition"></button>
                <button id="event-opt2" class="bg-blue-900/50 p-3 rounded-lg hover:bg-blue-800 transition"></button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-4xl font-black uppercase tracking-widest text-white">Daoist <span id="p-name" class="text-purple-500">...</span></h1>
                <p id="p-realm" class="text-yellow-500 font-bold text-xl uppercase">Mortal</p>
            </div>
            <div class="flex gap-8 text-center bg-gray-900/50 p-4 rounded-2xl border border-white/5">
                <div><p class="text-[10px] text-gray-500 uppercase">Lifespan</p><p class="font-mono text-lg"><span id="age">18</span>/<span id="maxAge">100</span></p></div>
                <div><p class="text-[10px] text-gray-500 uppercase">Karma</p><p id="karma" class="font-mono text-lg text-green-400">0</p></div>
                <div><p class="text-[10px] text-gray-500 uppercase">Root</p><p id="root" class="font-mono text-lg text-cyan-400">1x</p></div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="space-y-6">
                <div class="mystic-border p-6 rounded-2xl">
                    <h2 class="text-sm font-bold uppercase text-gray-500 mb-4">Qi Reservoir</h2>
                    <div class="text-4xl font-mono font-bold mb-2" id="qi-val">0</div>
                    <div class="w-full bg-black/50 h-2 rounded-full overflow-hidden">
                        <div id="qi-bar" class="qi-gradient h-full transition-all duration-300"></div>
                    </div>
                    <div class="flex justify-between text-[10px] mt-2 text-gray-500">
                        <span>Rate: <b id="rate-val">0</b>/s</span>
                        <span>Success: <b id="success-val">100%</b></span>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="game.buyUpgrade('spirit')" class="mystic-border p-4 rounded-xl flex justify-between items-center hover:bg-purple-900/20 transition">
                        <div class="text-left">
                            <p class="font-bold text-purple-300">Gathering Array</p>
                            <p class="text-[10px] text-gray-500">Increase Absorption</p>
                        </div>
                        <span id="cost-spirit" class="text-yellow-500 font-mono">10</span>
                    </button>
                    <button onclick="game.buyUpgrade('tech')" class="mystic-border p-4 rounded-xl flex justify-between items-center hover:bg-orange-900/20 transition">
                        <div class="text-left">
                            <p class="font-bold text-orange-400">Mental Method</p>
                            <p class="text-[10px] text-gray-500">Multiply Gains</p>
                        </div>
                        <span id="cost-tech" class="text-yellow-500 font-mono">50</span>
                    </button>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <div class="mystic-border h-80 rounded-3xl flex flex-col items-center justify-center relative overflow-hidden bg-gradient-to-b from-transparent to-purple-950/20">
                    <div class="float relative z-10">
                        <button onclick="game.manualMeditate()" class="w-40 h-40 rounded-full border-4 border-purple-500/30 flex items-center justify-center bg-black/40 hover:scale-105 active:scale-95 transition-all shadow-[0_0_50px_var(--realm-color)]">
                            <span class="font-black tracking-tighter text-xl">MEDITATE</span>
                        </button>
                    </div>
                    <button id="break-btn" onclick="game.breakthrough()" class="hidden absolute bottom-6 w-3/4 bg-yellow-500 text-black font-black py-3 rounded-lg animate-pulse shadow-lg">FACING TRIBULATION</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="mystic-border p-4 rounded-2xl bg-black/20">
                        <h3 class="text-[10px] font-bold text-gray-600 uppercase mb-2">Daoist Records</h3>
                        <div id="log" class="h-48 overflow-y-auto text-[11px] space-y-1 font-mono text-gray-400"></div>
                    </div>
                    <div class="mystic-border p-4 rounded-2xl flex flex-col h-64">
                        <h2 class="text-[10px] font-bold uppercase text-gray-600 mb-2">World Transmission</h2>
                        <div id="chat" class="flex-grow overflow-y-auto space-y-2 mb-2 text-xs"></div>
                        <form id="chat-form" class="flex gap-2">
                            <input id="chat-input" type="text" placeholder="..." class="bg-black/50 border border-white/10 rounded p-1 flex-grow outline-none text-xs">
                            <button class="bg-purple-600 px-2 rounded font-bold text-[10px]">SEND</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="mystic-border p-6 rounded-2xl">
                <h2 class="text-sm font-bold uppercase text-purple-400 mb-4 border-b border-purple-900/50 pb-2">Immortal Rankings</h2>
                <ul id="leaderboard-list" class="space-y-3">
                    <li class="text-center text-gray-600 text-xs py-4 italic">Fetching Daoists...</li>
                </ul>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD7N-ZUGKm9hasgM0DD08scouydEEuiLvU",
            authDomain: "path-to-immortality-78ad8.firebaseapp.com",
            projectId: "path-to-immortality-78ad8",
            storageBucket: "path-to-immortality-78ad8.firebasestorage.app",
            messagingSenderId: "653760996266",
            appId: "1:653760996266:web:59c8dc7158cba0722e01d3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const SAVE_KEY = "ImmortalSovereign_V6";

        const game = {
            state: {
                name: "", qi: 0, realmIdx: 0, age: 18, maxAge: 100,
                upgrades: { spirit: 0, tech: 0 },
                karma: 0, rootMult: 1, lastTick: Date.now()
            },
            realms: [
                "Mortal Body", "Refined Body", "Tempered Flesh", "Bone Forging", "Blood Circulation", "Muscle Cleansing", "Meridian Awakening", "Qi Sense", "Qi Initiation", "Qi Condensation", "Qi Gathering", "Qi Foundation", "Qi Stabilization",
                "Foundation Establishment", "Foundation Perfection", "Spirit Root Awakening", "Spirit Root Tempering", "Spirit Root Harmonization", "Golden Core (Early)", "Golden Core (Middle)", "Golden Core (Late)", "Golden Core (Perfected)",
                "False Nascent Soul", "Nascent Soul (Early)", "Nascent Soul (Middle)", "Nascent Soul (Late)", "Nascent Soul (Perfected)", "Soul Infant", "Soul Transformation", "Soul Ascension", "Soul Integration",
                "Spirit Severing", "Spirit Fusion", "Void Perception", "Void Refinement", "Dao Seed Formation", "Dao Comprehension", "Dao Integration", "Dao Manifestation", "Dao King",
                "Earth Immortal", "Sky Immortal", "True Immortal", "Golden Immortal", "Heavenly Immortal", "Immortal Lord", "Immortal King", "Immortal Emperor",
                "Pseudo-God", "Minor Deity", "True Deity", "High Deity", "Divine Lord", "Divine King", "Divine Emperor",
                "Primordial Body", "Primordial Soul", "Primordial Dao", "Origin Being", "Origin Sovereign", "Origin Emperor",
                "Void Ancestor", "Chaos Walker", "Chaos Sovereign", "Chaos Emperor", "Existence Transcendent", "Law Devourer", "Reality Shaper", "World Creator", "Multiverse Sovereign", "Omni-Existence", "Beyond Heaven", "Boundless One", "Absolute Apex"
            ].map((n, i) => ({
                name: n,
                req: Math.floor(100 * Math.pow(1.68, i)),
                color: `hsl(${250 + (i * 3)}, 70%, 50%)`,
                chance: Math.max(0.05, 1 - (i * 0.015))
            })),

            init() {
                const saved = localStorage.getItem(SAVE_KEY);
                if (saved) this.state = {...this.state, ...JSON.parse(saved)};
                if (!this.state.name) this.state.name = prompt("Enter your Daoist Name:") || "Unknown";
                
                this.setupNetwork();
                this.listenToLeaderboard();
                setInterval(() => this.tick(), 100);
                setInterval(() => this.randomEvent(), 45000);
                this.render();
            },

            tick() {
                const dt = (Date.now() - this.state.lastTick) / 1000;
                this.state.lastTick = Date.now();
                const rate = (1 + this.state.upgrades.spirit) * (1 + this.state.upgrades.tech * 2) * Math.pow(1.5, this.state.realmIdx) * this.state.rootMult;
                const currentReq = this.realms[this.state.realmIdx].req;
                this.state.qi = Math.min(currentReq, this.state.qi + (rate * dt));
                this.state.age += dt / 60;
                if (this.state.age >= this.state.maxAge) this.die();
                this.render(rate);
            },

            manualMeditate() {
                const power = (10 + (this.state.realmIdx * 50)) * this.state.rootMult;
                this.state.qi = Math.min(this.realms[this.state.realmIdx].req, this.state.qi + power);
            },

            buyUpgrade(type) {
                const cost = Math.floor((type === 'spirit' ? 10 : 100) * Math.pow(1.8, this.state.upgrades[type]));
                if (this.state.qi >= cost) {
                    this.state.qi -= cost;
                    this.state.upgrades[type]++;
                    this.addLog(`Purchased ${type} upgrade.`);
                }
            },

            async breakthrough() {
                const r = this.realms[this.state.realmIdx];
                document.body.classList.add('strike');
                setTimeout(() => document.body.classList.remove('strike'), 400);

                if (Math.random() <= r.chance) {
                    this.state.realmIdx++;
                    this.state.qi = 0;
                    this.state.maxAge += 50;
                    this.addLog(`<span class="text-yellow-400 font-bold">★ Breakthrough to ${this.realms[this.state.realmIdx].name}!</span>`);
                    await addDoc(collection(db, "highscores"), { player: this.state.name, realm: this.realms[this.state.realmIdx].name, level: this.state.realmIdx, createdAt: serverTimestamp() });
                } else {
                    this.state.qi *= 0.5;
                    this.addLog(`<span class="text-red-500">⚡ Lightning Strike! Qi scattered.</span>`);
                }
                localStorage.setItem(SAVE_KEY, JSON.stringify(this.state));
            },

            randomEvent() {
                const modal = document.getElementById('event-modal');
                const events = [
                    { t: "Ancient Ruins", d: "Study jade slip?", o1: "Study (Qi)", o2: "Ignore (Karma)", r1: () => this.state.qi += 500, r2: () => this.state.karma += 50 },
                    { t: "Rival Daoist", d: "A challenge!", o1: "Fight (Qi Risk)", o2: "Flee (Age)", r1: () => Math.random() > 0.5 ? this.state.qi *= 2 : this.state.qi *= 0.1, r2: () => this.state.age += 5 }
                ];
                const e = events[Math.floor(Math.random() * events.length)];
                document.getElementById('event-title').innerText = e.t;
                document.getElementById('event-desc').innerText = e.d;
                document.getElementById('event-opt1').innerText = e.o1;
                document.getElementById('event-opt2').innerText = e.o2;
                modal.style.display = 'flex';
                document.getElementById('event-opt1').onclick = () => { e.r1(); modal.style.display = 'none'; };
                document.getElementById('event-opt2').onclick = () => { e.r2(); modal.style.display = 'none'; };
            },

            die() {
                const gain = this.state.realmIdx * 20;
                this.state.karma += gain;
                document.getElementById('reincarnation-screen').style.display = 'flex';
                document.getElementById('death-msg').innerText = `${this.state.name} perished as ${this.realms[this.state.realmIdx].name}.`;
                document.getElementById('karma-gain').innerText = gain;
            },

            reincarnate(mult, cost) {
                if (this.state.karma < cost) return alert("Not enough Karma!");
                this.state.karma -= cost;
                this.state.rootMult = mult;
                this.state.age = 18; this.state.maxAge = 100; this.state.realmIdx = 0; this.state.qi = 0;
                this.state.upgrades = { spirit: 0, tech: 0 };
                document.getElementById('reincarnation-screen').style.display = 'none';
                localStorage.setItem(SAVE_KEY, JSON.stringify(this.state));
            },

            render(rate = 0) {
                const r = this.realms[this.state.realmIdx];
                document.getElementById('p-name').innerText = this.state.name;
                document.getElementById('p-realm').innerText = r.name;
                document.getElementById('qi-val').innerText = Math.floor(this.state.qi).toLocaleString();
                document.getElementById('qi-bar').style.width = (this.state.qi / r.req * 100) + "%";
                document.getElementById('age').innerText = Math.floor(this.state.age);
                document.getElementById('maxAge').innerText = Math.floor(this.state.maxAge);
                document.getElementById('karma').innerText = this.state.karma;
                document.getElementById('root').innerText = this.state.rootMult + "x";
                document.getElementById('rate-val').innerText = Math.floor(rate).toLocaleString();
                document.getElementById('success-val').innerText = (r.chance * 100).toFixed(0) + "%";
                document.documentElement.style.setProperty('--realm-color', r.color);
                document.getElementById('break-btn').style.display = (this.state.qi >= r.req) ? 'block' : 'none';
                document.getElementById('cost-spirit').innerText = Math.floor(10 * Math.pow(1.8, this.state.upgrades.spirit)).toLocaleString();
                document.getElementById('cost-tech').innerText = Math.floor(100 * Math.pow(1.8, this.state.upgrades.tech)).toLocaleString();
            },

            addLog(msg) {
                const log = document.getElementById('log');
                log.innerHTML = `<div class="border-l-2 border-purple-500 pl-2 mb-1">${msg}</div>` + log.innerHTML;
            },

            listenToLeaderboard() {
                const q = query(collection(db, "highscores"), orderBy("level", "desc"), limit(10));
                onSnapshot(q, (sn) => {
                    const list = document.getElementById('leaderboard-list');
                    list.innerHTML = "";
                    sn.forEach(d => {
                        const data = d.data();
                        list.innerHTML += `<li class="p-2 bg-white/5 rounded border-l-2 border-purple-500">
                            <div class="text-[11px] font-bold">${data.player}</div>
                            <div class="text-[9px] text-yellow-500 uppercase">${data.realm}</div>
                        </li>`;
                    });
                });
            },

            setupNetwork() {
                const qMsg = query(collection(db, "messages"), orderBy("createdAt", "desc"), limit(15));
                onSnapshot(qMsg, (sn) => {
                    const chat = document.getElementById('chat'); chat.innerHTML = "";
                    sn.forEach(d => {
                        const data = d.data();
                        chat.innerHTML += `<div><b class="text-purple-400">${data.user}</b>: <span class="text-gray-400">${data.text}</span></div>`;
                    });
                });
                document.getElementById('chat-form').onsubmit = async (e) => {
                    e.preventDefault();
                    const input = document.getElementById('chat-input');
                    if (!input.value.trim()) return;
                    await addDoc(collection(db, "messages"), { user: this.state.name, text: input.value, createdAt: serverTimestamp() });
                    input.value = "";
                };
            }
        };

        window.game = game;
        game.init();
    </script>
</body>
</html>
