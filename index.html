<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, setDoc, query, orderBy, limit, onSnapshot, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD7N-ZUGKm9hasgM0DD08scouydEEuiLvU",
        authDomain: "path-to-immortality-78ad8.firebaseapp.com",
        projectId: "path-to-immortality-78ad8",
        storageBucket: "path-to-immortality-78ad8.firebasestorage.app",
        messagingSenderId: "653760996266",
        appId: "1:653760996266:web:59c8dc7158cba0722e01d3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const SAVE_KEY = "ImmortalSovereign_V7_Fog";

    const game = {
        state: {
            name: "", qi: 0, realmIdx: 0, age: 18, maxAge: 100,
            upgrades: { spirit: 0, tech: 0 },
            karma: 0, rootMult: 1, lastTick: Date.now(),
            technique: "dao", pos: -1, techniqueChosen: false,
            isDead: false, moveCooldown: 0
        },
        mapData: Array(25).fill(null).map((_, i) => ({ id: i, lord: null, level: 0, density: 1 + (i % 5 * 0.5), lordQi: 0 })),
        realms: [
            "Mortal Body", "Refined Body", "Tempered Flesh", "Bone Forging", "Blood Circulation", "Muscle Cleansing", "Meridian Awakening", "Qi Sense", "Qi Initiation", "Qi Condensation", "Qi Gathering", "Qi Foundation", "Qi Stabilization",
            "Foundation Establishment", "Foundation Perfection", "Spirit Root Awakening", "Spirit Root Tempering", "Spirit Root Harmonization", "Golden Core (Early)", "Golden Core (Middle)", "Golden Core (Late)", "Golden Core (Perfected)",
            "False Nascent Soul", "Nascent Soul (Early)", "Nascent Soul (Middle)", "Nascent Soul (Late)", "Nascent Soul (Perfected)", "Soul Infant", "Soul Transformation", "Soul Ascension", "Soul Integration",
            "Spirit Severing", "Spirit Fusion", "Void Perception", "Void Refinement", "Dao Seed Formation", "Dao Comprehension", "Dao Integration", "Dao Manifestation", "Dao King",
            "Earth Immortal", "Sky Immortal", "True Immortal", "Golden Immortal", "Heavenly Immortal", "Immortal Lord", "Immortal King", "Immortal Emperor",
            "Pseudo-God", "Minor Deity", "True Deity", "High Deity", "Divine Lord", "Divine King", "Divine Emperor",
            "Primordial Body", "Primordial Soul", "Primordial Dao", "Origin Being", "Origin Sovereign", "Origin Emperor",
            "Void Ancestor", "Chaos Walker", "Chaos Sovereign", "Chaos Emperor", "Existence Transcendent", "Law Devourer", "Reality Shaper", "World Creator", "Multiverse Sovereign", "Omni-Existence", "Beyond Heaven", "Boundless One", "Absolute Apex"
        ].map((n, i) => ({
            name: n, req: Math.floor(100 * Math.pow(1.68, i)), color: `hsl(${250 + (i * 3)}, 70%, 50%)`, chance: Math.max(0.05, 1 - (i * 0.015))
        })),

        init() {
            const saved = localStorage.getItem(SAVE_KEY);
            if (saved) this.state = {...this.state, ...JSON.parse(saved)};
            if (!this.state.name) this.state.name = prompt("Enter your Daoist Name:") || "Daoist_" + Math.floor(Math.random()*999);
            if (this.state.pos === -1) this.state.pos = Math.floor(Math.random() * 25);
            
            this.setupNetwork();
            this.listenToLeaderboard();
            this.listenToMap();
            if (!this.state.techniqueChosen) document.getElementById('technique-screen').style.display = 'flex';

            setInterval(() => this.tick(), 100);
            setInterval(() => this.save(), 5000);
            this.render();
        },

        save() { localStorage.setItem(SAVE_KEY, JSON.stringify(this.state)); },

        tick() {
            if (this.state.isDead) return;
            const now = Date.now();
            const dt = (now - this.state.lastTick) / 1000;
            this.state.lastTick = now;

            if (this.state.moveCooldown > 0) this.state.moveCooldown -= dt;

            let techRate = this.state.technique === 'turtle' ? 0.7 : (this.state.technique === 'phoenix' ? 2.0 : 1.0);
            const currentTile = this.mapData[this.state.pos];
            const mapBonus = (currentTile && currentTile.lord === this.state.name) ? currentTile.density : 1.0;
            
            const rate = (1 + this.state.upgrades.spirit) * Math.pow(1.5, this.state.realmIdx) * this.state.rootMult * techRate * mapBonus;
            const targetReq = this.realms[this.state.realmIdx].req;
            this.state.qi = Math.min(targetReq, this.state.qi + (rate * dt));
            
            this.state.age += dt / 60;
            if (this.state.age >= this.state.maxAge) this.die();
            this.render(rate);
        },

        async occupyTile(id) {
            if (this.state.moveCooldown > 0) return this.addLog(`<span class="text-orange-400">Qi unstable! Wait ${Math.ceil(this.state.moveCooldown)}s.</span>`);
            
            const target = this.mapData[id];
            const myRow = Math.floor(this.state.pos / 5); const myCol = this.state.pos % 5;
            const tRow = Math.floor(id / 5); const tCol = id % 5;
            
            if (Math.abs(myRow - tRow) > 1 || Math.abs(myCol - tCol) > 1) return this.addLog("Too far to travel.");
            if (target.lord === this.state.name) return;

            // BATTLE LOGIC
            if (target.lord) {
                this.addLog(`⚔️ Challenging ${target.lord}...`);
                let win = false;
                if (this.state.realmIdx > target.level) win = true;
                else if (this.state.realmIdx === target.level && this.state.qi > (target.lordQi || 0)) win = true;

                if (!win) {
                    this.state.qi *= 0.7; // Qi Shock penalty
                    this.state.moveCooldown = 5;
                    this.triggerFlash('red');
                    return this.addLog(`<span class="text-red-500 font-bold">BATTLE LOST! ${target.lord} suppressed your Dao.</span>`);
                }
                this.triggerFlash('gold');
                this.addLog(`<span class="text-yellow-400 font-bold">BATTLE WON! You drove ${target.lord} away.</span>`);
            }

            // Successfully occupy
            await setDoc(doc(db, "map", `tile_${id}`), { 
                lord: this.state.name, 
                level: this.state.realmIdx, 
                lordQi: this.state.qi,
                density: target.density, 
                at: serverTimestamp() 
            });
            this.state.pos = id;
            this.save();
        },

        triggerFlash(color) {
            const overlay = document.createElement('div');
            overlay.className = `fixed inset-0 z-[100] pointer-events-none opacity-30 bg-${color === 'red' ? 'red-600' : 'yellow-500'}`;
            document.body.appendChild(overlay);
            setTimeout(() => overlay.remove(), 200);
        },

        // ... Keep existing breakthrough, die, reincarnate, listenToMap, setupNetwork functions ...
        // Ensure that setDoc in breakthrough() updates your lordQi on the map if you own a tile
    };

    window.game = game;
    game.init();
</script>
